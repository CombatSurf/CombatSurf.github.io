<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CombatSurf - Updates</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="updates.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="logo">
      <img src="images/logo.png" alt="CombatSurf Logo" id="logo-img">
    </div>
    <nav>
      <ul class="nav-links">
        <li class="auth-status logged-out"><a href="login.html"><i class="fas fa-user"></i> log/reg</a></li>
        <li class="auth-status logged-in">
          <a href="#"><i class="fas fa-user-circle"></i> <span class="username">User</span> <i class="fas fa-caret-down"></i></a>
          <div class="dropdown-menu">
            <a href="#" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
          </div>
        </li>
        <li><a href="index.html"><i class="fas fa-home"></i> home<br>home wb</a></li>
        <li><a href="rap-price.html"><i class="fas fa-tags"></i> rap<br>price</a></li>
        <li><a href="skins.html"><i class="fas fa-palette"></i> index skins<br>value & Previews</a></li>
        <li><a href="https://discord.gg/combatsurf" target="_blank"><i class="fab fa-discord"></i> discord comunity<br>roblox group</a></li>
        <li><a href="updates.html" class="active"><i class="fas fa-sync-alt"></i> updates<br>changelog</a></li>
        <li><a href="comments.html"><i class="fas fa-comments"></i> comments<br>people's comments</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="updates-section">
      <h1>Updates & Changelog</h1>
      <p class="section-description">Stay up to date with the latest changes and improvements to CombatSurf</p>
      
      <!-- Formulario para añadir actualizaciones (solo para administradores) -->
      <div class="auth-status logged-in admin-only">
        <div class="update-form-container">
          <h3><i class="fas fa-plus-circle"></i> Add New Update</h3>
          <form id="update-form">
            <div class="form-group">
              <label for="update-title">Title</label>
              <input type="text" id="update-title" placeholder="Update title" required>
            </div>
            <div class="form-group">
              <label for="update-version">Version</label>
              <input type="text" id="update-version" placeholder="e.g. v1.2.3" required>
            </div>
            <div class="form-group">
              <label for="update-content">Content</label>
              <textarea id="update-content" placeholder="Describe the changes..." required></textarea>
            </div>
            <button type="submit" class="submit-btn"><i class="fas fa-paper-plane"></i> Publish Update</button>
          </form>
        </div>
      </div>
      
      <!-- Lista de actualizaciones -->
      <div class="updates-container">
        <div class="updates-filter">
          <button class="filter-btn active" data-filter="all">All Updates</button>
          <button class="filter-btn" data-filter="major">Major Updates</button>
          <button class="filter-btn" data-filter="minor">Minor Updates</button>
        </div>
        
        <div id="updates-list">
          <!-- Las actualizaciones se cargarán dinámicamente aquí -->
          <div class="no-updates-message">
            <i class="fas fa-exclamation-circle"></i>
            <p>No updates available yet.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>Dev Website Brownuser_ <i class="fas fa-code"></i></p>
  </footer>

  <script src="auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar la interfaz según el rol del usuario
      updateAdminUI();
      
      // Cargar actualizaciones
      loadUpdates();
      
      // Configurar el formulario de actualizaciones
      const updateForm = document.getElementById('update-form');
      if (updateForm) {
        updateForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          if (!isAdmin()) {
            alert('Only administrators can add updates');
            return;
          }
          
          const title = document.getElementById('update-title').value.trim();
          const version = document.getElementById('update-version').value.trim();
          const content = document.getElementById('update-content').value.trim();
          
          if (!title || !version || !content) {
            alert('Please fill in all fields');
            return;
          }
          
          addUpdate(title, version, content);
          updateForm.reset();
        });
      }
      
      // Configurar filtros
      const filterButtons = document.querySelectorAll('.filter-btn');
      filterButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Quitar clase activa de todos los botones
          filterButtons.forEach(btn => btn.classList.remove('active'));
          
          // Añadir clase activa al botón clickeado
          this.classList.add('active');
          
          // Aplicar filtro
          const filter = this.dataset.filter;
          filterUpdates(filter);
        });
      });
    });
    
    // Actualizar la interfaz según el rol del usuario
    function updateAdminUI() {
      const adminElements = document.querySelectorAll('.admin-only');
      
      if (isAdmin()) {
        adminElements.forEach(el => {
          el.style.display = 'block';
        });
      } else {
        adminElements.forEach(el => {
          el.style.display = 'none';
        });
      }
    }
    
    // Cargar actualizaciones desde localStorage
    function loadUpdates() {
      const updatesContainer = document.getElementById('updates-list');
      const updates = JSON.parse(localStorage.getItem('updates') || '[]');
      
      // Limpiar el contenedor
      updatesContainer.innerHTML = '';
      
      if (updates.length === 0) {
        updatesContainer.innerHTML = `
          <div class="no-updates-message">
            <i class="fas fa-exclamation-circle"></i>
            <p>No updates available yet.</p>
          </div>
        `;
        return;
      }
      
      // Ordenar actualizaciones por fecha (más recientes primero)
      updates.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      // Mostrar cada actualización
      updates.forEach(update => {
        const updateElement = createUpdateElement(update);
        updatesContainer.appendChild(updateElement);
      });
    }
    
    // Crear elemento de actualización
    function createUpdateElement(update) {
      const updateDiv = document.createElement('div');
      updateDiv.className = `update-item ${getUpdateType(update.version)}`;
      updateDiv.dataset.id = update.id;
      updateDiv.dataset.type = getUpdateType(update.version);
      
      // Formatear la fecha
      const date = new Date(update.createdAt);
      const formattedDate = date.toLocaleDateString('es-ES', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric'
      });
      
      updateDiv.innerHTML = `
        <div class="update-header">
          <div class="update-title-container">
            <h3 class="update-title">${update.title}</h3>
            <span class="update-version">${update.version}</span>
          </div>
          <div class="update-date">
            <i class="far fa-calendar-alt"></i>
            <span>${formattedDate}</span>
          </div>
        </div>
        <div class="update-content">
          <p>${formatUpdateContent(update.content)}</p>
        </div>
        ${isAdmin() ? `
        <div class="update-actions">
          <button class="delete-btn" onclick="deleteUpdate('${update.id}')">
            <i class="fas fa-trash-alt"></i> Delete
          </button>
        </div>
        ` : ''}
      `;
      
      return updateDiv;
    }
    
    // Determinar el tipo de actualización basado en la versión
    function getUpdateType(version) {
      // Extraer el primer número de la versión (asumiendo formato semántico x.y.z)
      const match = version.match(/v?(\d+)\.\d+/);
      
      if (match && match[1]) {
        // Si el primer número es mayor que 0, considerarlo una actualización mayor
        return parseInt(match[1]) > 0 ? 'major' : 'minor';
      }
      
      return 'minor'; // Por defecto, considerar actualizaciones menores
    }
    
    // Formatear el contenido de la actualización (convertir saltos de línea en <br>)
    function formatUpdateContent(content) {
      return content.replace(/\n/g, '<br>');
    }
    
    // Añadir una nueva actualización
    function addUpdate(title, version, content) {
      if (!isAdmin()) return;
      
      const updates = JSON.parse(localStorage.getItem('updates') || '[]');
      
      const newUpdate = {
        id: Date.now().toString(),
        title: title,
        version: version,
        content: content,
        createdAt: new Date().toISOString(),
        author: getCurrentUser().username
      };
      
      updates.push(newUpdate);
      localStorage.setItem('updates', JSON.stringify(updates));
      
      // Recargar actualizaciones
      loadUpdates();
      
      // Mostrar animación
      const updatesContainer = document.getElementById('updates-list');
      const firstUpdate = updatesContainer.querySelector('.update-item');
      if (firstUpdate) {
        firstUpdate.classList.add('highlight');
        setTimeout(() => {
          firstUpdate.classList.remove('highlight');
        }, 1500);
      }
    }
    
    // Eliminar una actualización
    function deleteUpdate(updateId) {
      if (!isAdmin()) return;
      
      let updates = JSON.parse(localStorage.getItem('updates') || '[]');
      
      // Animar la eliminación
      const updateElement = document.querySelector(`.update-item[data-id="${updateId}"]`);
      if (updateElement) {
        updateElement.classList.add('deleting');
        
        setTimeout(() => {
          // Filtrar la actualización
          updates = updates.filter(u => u.id !== updateId);
          localStorage.setItem('updates', JSON.stringify(updates));
          
          // Recargar actualizaciones
          loadUpdates();
        }, 500);
      }
    }
    
    // Filtrar actualizaciones
    function filterUpdates(filter) {
      const updates = document.querySelectorAll('.update-item');
      
      updates.forEach(update => {
        if (filter === 'all' || update.dataset.type === filter) {
          update.style.display = 'block';
        } else {
          update.style.display = 'none';
        }
      });
      
      // Mostrar mensaje si no hay actualizaciones visibles
      const visibleUpdates = document.querySelectorAll('.update-item[style="display: block"]');
      const noUpdatesMessage = document.querySelector('.no-updates-message');
      
      if (visibleUpdates.length === 0 && !noUpdatesMessage) {
        const updatesContainer = document.getElementById('updates-list');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'no-updates-message filter-message';
        messageDiv.innerHTML = `
          <i class="fas fa-filter"></i>
          <p>No ${filter} updates available.</p>
        `;
        updatesContainer.appendChild(messageDiv);
      } else if (visibleUpdates.length > 0) {
        const filterMessage = document.querySelector('.filter-message');
        if (filterMessage) {
          filterMessage.remove();
        }
      }
    }
  </script>
</body>
</html>
